name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install build

      - name: Build release artifacts
        run: python scripts/build_release.py

      - name: Import GPG key
        run: |
          if [ -n "$GPG_PRIVATE_KEY" ]; then
            echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          else
            echo "GPG_PRIVATE_KEY not set; skipping import."
          fi
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: Sign artifacts
        run: |
          if [ -n "$GPG_PRIVATE_KEY" ]; then
            python scripts/sign_release.py
          else
            echo "GPG_PRIVATE_KEY not set; skipping signing."
          fi
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/*

  gui:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python: ["3.13"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e ".[dev]"
          python -m pip install pyinstaller pillow

      - name: Build GUI bundle
        run: |
          python scripts/build_gui.py --output-dir dist/gui --name dem2dsf-gui --onedir --noconfirm

      - name: Upload GUI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gui-${{ matrix.os }}
          path: dist/gui

  publish:
    runs-on: ubuntu-latest
    needs: [build, gui]
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Download dist artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: release/dist

      - name: Download GUI artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: gui-*
          path: release/gui

      - name: Package GUI artifacts
        run: |
          python - <<'PY'
          from pathlib import Path
          import zipfile

          root = Path("release/gui")
          for artifact_dir in root.iterdir():
            if not artifact_dir.is_dir():
              continue
            archive = root / f"{artifact_dir.name}.zip"
            with zipfile.ZipFile(archive, "w", zipfile.ZIP_DEFLATED) as zf:
              for path in artifact_dir.rglob("*"):
                if path.is_file():
                  zf.write(path, path.relative_to(artifact_dir))
          PY

      - name: Upload release assets (skip existing)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          python - <<'PY'
          import json
          import os
          import pathlib
          import subprocess
          import sys

          tag = os.environ.get("GITHUB_REF_NAME")
          if not tag:
            print("GITHUB_REF_NAME is not set.", file=sys.stderr)
            sys.exit(1)

          def run(cmd, check=True):
            return subprocess.run(cmd, check=check, text=True, capture_output=True)

          view = run(["gh", "release", "view", tag, "--json", "assets"], check=False)
          if view.returncode != 0:
            notes_file = pathlib.Path("docs/release_notes.md")
            create_cmd = ["gh", "release", "create", tag, "--title", tag]
            if notes_file.exists():
              create_cmd += ["--notes-file", str(notes_file)]
            else:
              create_cmd.append("--generate-notes")
            run(create_cmd)
            view = run(["gh", "release", "view", tag, "--json", "assets"])

          assets = json.loads(view.stdout).get("assets", [])
          existing = {asset["name"] for asset in assets}

          files = []
          files.extend(sorted(pathlib.Path("release/dist").glob("*")))
          files.extend(sorted(pathlib.Path("release/gui").glob("*.zip")))

          to_upload = [path for path in files if path.name not in existing]
          if not to_upload:
            print("No new assets to upload.")
            sys.exit(0)

          print("Uploading:", ", ".join(path.name for path in to_upload))
          run(["gh", "release", "upload", tag, *[str(path) for path in to_upload]])
          PY
